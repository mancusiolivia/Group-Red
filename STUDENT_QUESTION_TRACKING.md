# Student Question Tracking Implementation

## Overview

This document describes the implementation of student question tracking, which allows the system to:
1. Track which student generated each exam/question
2. Retrieve all questions for a specific student by their `student_id`
3. Enable students to retry past questions

## Database Changes

### Modified Table: `exams`
- **Added Column**: `student_id` (String, nullable)
  - Stores the student's campus ID (string) who generated the exam
  - References `students.student_id` (not a foreign key constraint, but logical reference)
  - Nullable to support exams created by instructors or unauthenticated users

### Migration
- Migration runs automatically when the server starts
- The `init_db()` function in `server/core/database.py` checks for the column and adds it if missing
- Manual migration script also available: `server/database/migrate_add_student_id_to_exams.py`

## API Changes

### 1. Modified Endpoint: `POST /api/generate-questions`

**Changes:**
- Now accepts optional authentication via `get_current_user` (not `require_auth`)
- If a student is authenticated, their `student_id` is automatically captured and stored with the exam
- Works for both authenticated and unauthenticated users (backward compatible)

**How it works:**
1. If user is authenticated AND is a student:
   - Retrieves the student's campus ID (`student_id` string)
   - Stores it in the `Exam.student_id` field
2. If user is not authenticated or is an instructor:
   - `student_id` remains `NULL` (backward compatible)

### 2. New Endpoint: `GET /api/student/{student_id}/questions`

**Purpose:** Retrieve all questions that have been generated for a specific student.

**Parameters:**
- `student_id` (path parameter): The student's campus ID (string)

**Response:**
```json
{
  "student_id": "STU123",
  "student_name": "John Doe",
  "total_exams": 2,
  "total_questions": 5,
  "exams": [
    {
      "exam_id": "123",
      "domain": "Computer Science",
      "title": "Computer Science Exam",
      "instructions_to_llm": "Focus on algorithms",
      "created_at": "2024-01-15T10:30:00",
      "questions": [
        {
          "question_id": "456",
          "exam_id": "123",
          "q_index": 1,
          "question_text": "Explain time complexity...",
          "background_info": "Background context...",
          "points_possible": 10.0,
          "grading_rubric": {...},
          "created_at": "2024-01-15T10:30:00"
        }
      ]
    }
  ]
}
```

**Error Handling:**
- Returns 404 if student_id doesn't exist

## Usage Examples

### 1. Generate Questions (Authenticated Student)

```bash
# Student must be logged in (session cookie required)
curl -X POST http://localhost:8000/api/generate-questions \
  -H "Content-Type: application/json" \
  -H "Cookie: session_token=..." \
  -d '{
    "domain": "History",
    "professor_instructions": "Focus on World War II",
    "num_questions": 3
  }'
```

The exam will be automatically associated with the student's `student_id`.

### 2. Retrieve All Questions for a Student

```bash
curl http://localhost:8000/api/student/STU123/questions
```

Returns all exams and questions generated by student with ID "STU123".

### 3. Generate Questions (Unauthenticated - Still Works)

```bash
# Works without authentication (backward compatible)
curl -X POST http://localhost:8000/api/generate-questions \
  -H "Content-Type: application/json" \
  -d '{
    "domain": "Math",
    "num_questions": 2
  }'
```

The exam will be created without a `student_id` (NULL).

## Database Schema Reference

### Exam Table
```sql
CREATE TABLE exams (
    id INTEGER PRIMARY KEY,
    instructor_id INTEGER NOT NULL,
    student_id TEXT,  -- NEW: Tracks which student generated this exam
    domain TEXT NOT NULL,
    title TEXT,
    instructions_to_llm TEXT,
    model_name TEXT,
    temperature REAL,
    created_at DATETIME NOT NULL,
    FOREIGN KEY (instructor_id) REFERENCES instructors(id)
);
```

### Query Examples

**Get all exams for a student:**
```sql
SELECT * FROM exams WHERE student_id = 'STU123' ORDER BY created_at DESC;
```

**Get all questions for a student:**
```sql
SELECT q.* 
FROM questions q
JOIN exams e ON q.exam_id = e.id
WHERE e.student_id = 'STU123'
ORDER BY e.created_at DESC, q.q_index;
```

## Next Steps (Frontend Integration)

To complete the implementation, the frontend should:

1. **Display Past Questions:**
   - Add a "My Past Questions" section
   - Call `GET /api/student/{student_id}/questions` to retrieve questions
   - Display exams and questions in a user-friendly format

2. **Retry Questions:**
   - Allow students to select a past question
   - Load the question into the exam interface
   - Enable them to answer it again (creates a new submission)

3. **Student ID Input:**
   - If not using authentication, allow students to enter their `student_id`
   - Store it when generating questions
   - Use it to retrieve past questions

## Testing

1. **Test Migration:**
   ```bash
   # Start server - migration runs automatically
   python3 run_server.py
   ```

2. **Test Question Generation with Student:**
   - Log in as a student
   - Generate questions
   - Check database: `SELECT * FROM exams WHERE student_id IS NOT NULL;`

3. **Test Retrieval:**
   ```bash
   curl http://localhost:8000/api/student/YOUR_STUDENT_ID/questions
   ```

## Notes

- The `student_id` field uses the **campus ID string** (e.g., "STU123"), not the database integer ID
- This allows easy lookup by the student's actual ID
- The relationship is logical (not enforced by foreign key) for flexibility
- Backward compatible: existing exams without `student_id` continue to work
